import { useState, useRef, useEffect } from 'react';
import { ArrowLeft, Info, Plus, Send, File, Image as ImageIcon, Camera, FileText, X, Trash2 } from 'lucide-react';
import './ChatWindow.css';

const ChatWindow = ({ chat, messages, onBack, onDeleteChat, onSendMessage }) => {
    const [message, setMessage] = useState('');
    const [showAttachments, setShowAttachments] = useState(false);
    const [showInfo, setShowInfo] = useState(false);
    const [showMediaGallery, setShowMediaGallery] = useState(false);
    const [mediaTab, setMediaTab] = useState('media'); // 'media', 'docs', 'links'
    const inputAreaRef = useRef(null);
    const sidebarRef = useRef(null); // Ref for sidebar to detect clicks outside
    const messagesEndRef = useRef(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    const currentMessages = messages || [];

    const handleSend = (e) => {
        e.preventDefault();
        if (!message.trim()) return;
        onSendMessage(message);
        setMessage('');
        setShowAttachments(false);
    };

    const handleBack = () => {
        if (showMediaGallery) {
            setShowMediaGallery(false);
        } else if (showInfo) {
            setShowInfo(false);
        } else {
            onBack();
        }
    };

    // Close menus when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            // Close attachment menu
            if (showAttachments && inputAreaRef.current && !inputAreaRef.current.contains(event.target)) {
                setShowAttachments(false);
            }

            // Close sidebar if clicking in main area (and sidebar is open)
            // Assuming the main area is everything NOT the sidebar
            if (showInfo && sidebarRef.current && !sidebarRef.current.contains(event.target) && !event.target.closest('.header-icon')) {
                // Check if click is not on the info icon itself (which toggles it)
                // Also ensure we aren't in the middle of opening it
                // Actually the user said "touch on screen it should get closed". 
                // We can check if the click target is within .chat-main-area
                if (event.target.closest('.chat-main-area')) {
                    setShowInfo(false);
                    setShowMediaGallery(false);
                }
            }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => {
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, [showAttachments, showInfo]);


    return (
        <div className="chat-window">
            {/* Main Chat Area */}
            <div className="chat-main-area">
                <div className="chat-header">
                    <div className="header-left">
                        <button className="back-button" onClick={handleBack}>
                            <ArrowLeft size={20} color="#718096" />
                        </button>
                        <div className="header-user-info">
                            <div className="header-avatar-container">
                                <img src={chat.avatar} alt={chat.name} className="header-avatar" />
                            </div>
                            <h3 className="header-name">{chat.name}</h3>
                        </div>
                    </div>
                    <div className="header-actions">
                        <Info
                            size={20}
                            color={showInfo ? "#3182CE" : "#A0AEC0"}
                            className="header-icon"
                            onClick={() => setShowInfo(!showInfo)}
                        />
                    </div>
                </div>

                <div className="chat-content">
                    {/* ... (Existing Message content) ... */}
                    <div className="date-separator">
                        <span>TODAY, OCT 12</span>
                    </div>

                    {currentMessages.map((msg) => (
                        <div key={msg.id} className={`message-row ${msg.sender === 'me' ? 'sent' : 'received'}`}>
                            {msg.sender === 'them' && (
                                <img src={chat.avatar} alt={chat.name} className="message-avatar" />
                            )}

                            <div className="message-bubble-container">
                                {msg.type === 'file' ? (
                                    <div className="file-attachment">
                                        <div className="file-icon-wrapper">
                                            <File size={24} color="#4299E1" />
                                        </div>
                                        <div className="file-info">
                                            <span className="file-name">{msg.fileName}</span>
                                            <span className="file-size">{msg.fileSize}</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="message-bubble">
                                        {msg.text}
                                    </div>
                                )}
                                <span className="message-time">{msg.time}</span>
                            </div>
                        </div>
                    ))}
                    <div ref={messagesEndRef} />
                </div>

                <div className="chat-input-area" ref={inputAreaRef}>
                    {/* ... (Existing Input logic) ... */}
                    <div className="attachment-wrapper">
                        <button
                            className={`input-action-btn ${showAttachments ? 'active' : ''}`}
                            onClick={() => setShowAttachments(!showAttachments)}
                        >
                            <Plus size={24} color={showAttachments ? "#3182CE" : "#A0AEC0"} style={{ transition: 'transform 0.2s', transform: showAttachments ? 'rotate(45deg)' : 'none' }} />
                        </button>

                        {showAttachments && (
                            <div className="attachment-menu">
                                <button className="attachment-option">
                                    <ImageIcon size={20} color="#4299E1" />
                                    <span>Photo & Video Library</span>
                                </button>
                                <button className="attachment-option">
                                    <Camera size={20} color="#4299E1" />
                                    <span>Camera</span>
                                </button>
                                <button className="attachment-option">
                                    <FileText size={20} color="#4299E1" />
                                    <span>Document</span>
                                </button>
                            </div>
                        )}
                    </div>

                    <form className="input-form" onSubmit={handleSend}>
                        <div className="input-container">
                            <input
                                type="text"
                                placeholder="Type a message..."
                                value={message}
                                onChange={(e) => setMessage(e.target.value)}
                                className="chat-text-input"
                            />
                        </div>
                        <button type="submit" className="send-button">
                            <Send size={18} color="white" />
                        </button>
                    </form>
                </div>
            </div>

            {/* Contact Info Sidebar */}
            {showInfo && (
                <div className="contact-info-sidebar" ref={sidebarRef}>
                    {showMediaGallery ? (
                        /* Media Gallery View */
                        <div className="media-gallery-view">
                            <div className="contact-info-header">
                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                    <button className="back-button" onClick={() => setShowMediaGallery(false)}>
                                        <ArrowLeft size={20} color="#718096" />
                                    </button>
                                    <h3>Media, Docs and Links</h3>
                                </div>
                                <button className="close-info-btn" onClick={() => setShowInfo(false)}>
                                    <X size={20} color="#A0AEC0" />
                                </button>
                            </div>

                            <div className="media-tabs">
                                <button className={`media-tab ${mediaTab === 'media' ? 'active' : ''}`} onClick={() => setMediaTab('media')}>Media</button>
                                <button className={`media-tab ${mediaTab === 'docs' ? 'active' : ''}`} onClick={() => setMediaTab('docs')}>Docs</button>
                                <button className={`media-tab ${mediaTab === 'links' ? 'active' : ''}`} onClick={() => setMediaTab('links')}>Links</button>
                            </div>

                            <div className="media-grid-content">
                                {mediaTab === 'media' && (
                                    <div className="media-preview-grid large">
                                        <div className="media-item blue"></div>
                                        <div className="media-item purple"></div>
                                        <div className="media-item pink"></div>
                                        <div className="media-item green"></div>
                                        <div className="media-item yellow"></div>
                                        <div className="media-item red"></div>
                                        <div className="media-item indigo"></div>
                                        <div className="media-item teal"></div>
                                        <div className="media-item orange"></div>
                                    </div>
                                )}
                                {mediaTab === 'docs' && <div className="empty-state">No documents</div>}
                                {mediaTab === 'links' && <div className="empty-state">No links</div>}
                            </div>
                        </div>
                    ) : (
                        /* Standard Profile View */
                        <>
                            <div className="contact-info-header">
                                <h3>Contact Info</h3>
                                <button className="close-info-btn" onClick={() => setShowInfo(false)}>
                                    <X size={20} color="#A0AEC0" />
                                </button>
                            </div>

                            <div className="contact-profile-section">
                                <img src={chat.avatar} alt={chat.name} className="contact-avatar-large" />
                                <h2 className="contact-name-large">{chat.name}</h2>
                            </div>

                            <div className="contact-details-section">
                                <div className="info-group">
                                    <label>ABOUT</label>
                                    <p>Designing delightful experiences. Coffee enthusiast â˜•</p>
                                </div>

                                <div className="info-group">
                                    <div className="media-header">
                                        <label>MEDIA, LINKS, AND DOCS</label>
                                        <button className="see-all-btn" onClick={() => setShowMediaGallery(true)}>See all</button>
                                    </div>
                                    <div className="media-preview-grid">
                                        <div className="media-item blue"></div>
                                        <div className="media-item purple"></div>
                                        <div className="media-item pink"></div>
                                    </div>
                                </div>

                                <div className="contact-actions-inline">
                                    <button className="delete-chat-btn" onClick={() => onDeleteChat(chat.id)}>
                                        <Trash2 size={18} />
                                        <span>Delete Chat</span>
                                    </button>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            )}


        </div>
    );
};

export default ChatWindow;
